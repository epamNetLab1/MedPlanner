<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>MedPlanner</title>
    <link href='fullcalendar/fullcalendar.css' rel='stylesheet' />
    <link href='fullcalendar/fullcalendar.print.css' rel='stylesheet' media='print' />
    <link href="fullcalendar/lib/jquery-ui-1.12.1.custom/jquery-ui.css" rel="stylesheet">
    <script src='fullcalendar/lib/moment.min.js'></script>
    <script src='fullcalendar/lib/jquery.min.js'></script>
    <script src='fullcalendar/fullcalendar.js'></script>
    <script src='fullcalendar/locale-all.js'></script>
    <script src="fullcalendar/lib/jquery-ui-1.12.1.custom/jquery-ui.js"></script>
    <script>
        var timeOfWeekExamination1 = [{
            "title": "Кац",
            "start": "2016-10-10T10:30:00",
            "end": "2016-10-10T12:30:00",
            "duration": "30"
        },
        {
            "title": "Иванов",
            "start": "2016-10-10T15:30:00",
            "end": "2016-10-10T20:00:00",
            "duration": "20"
        },
        {
            "title": "Петров",
            "start": "2016-10-11T08:30:00",
            "end": "2016-10-11T14:00:00"
        },
        {
            "title": "Иванов",
            "start": "2016-10-11T16:00:00",
            "end": "2016-10-11T21:00:00",
            "duration": "20"
        },
        {
            "title": "Сидоров",
            "start": "2016-10-12T09:30:00",
            "end": "2016-10-12T12:30:00",
            "duration": "40"
        },
        {
            "title": "Kац",
            "start": "2016-10-12T17:30:00",
            "end": "2016-10-12T18:30:00",
            "duration": "30"
        },
        {
            "title": "Кац",
            "start": "2016-10-12T19:00:00",
            "end": "2016-10-12T20:00:00",
            "duration": "30"
        },
        {
            "title": "Кац",
            "start": "2016-10-13T09:00:00",
            "end": "2016-10-13T13:00:00",
            "duration": "30"
        },
        {
            "title": "Иванов",
            "start": "2016-10-13T13:30:00",
            "end": "2016-10-13T18:30:00",
            "duration": "20"
        },
        {
            "title": "Петров",
            "start": "2016-10-14T08:30:00",
            "end": "2016-10-14T12:30:00",
            "duration": "90"
        },
        {
            "title": "Иванов",
            "start": "2016-10-14T14:30:00",
            "end": "2016-10-14T18:30:00",
            "duration": "20"
        },
        {
            "title": "Кац",
            "start": "2016-10-15T09:30:00",
            "end": "2016-10-15T12:00:00",
            "duration": "30"
        },
        {
            "title": "Сидоров",
            "start": "2016-10-15T15:30:00",
            "end": "2016-10-15T21:30:00",
            "duration": "40"
        },
        {
            "title": "Кац",
            "start": "2016-10-16T08:30:00",
            "end": "2016-10-16T10:30:00",
            "duration": "30"
        },
        {
            "title": "Сидоров",
            "start": "2016-10-16T09:30:00",
            "end": "2016-10-16T15:30:00",
            "duration": "40"
        }];
        var timeOfWeekExamination2 = [
        {
            "title": "Иванов",
            "start": "2016-10-17T10:30:00",
            "end": "2016-10-17T12:30:00",
            "duration": "20"
        },
        {
            "title": "Кац",
            "start": "2016-10-17T15:30:00",
            "end": "2016-10-17T20:00:00",
            "duration": "30"
        },
        {
            "title": "Петров",
            "start": "2016-10-18T08:30:00",
            "end": "2016-10-18T14:00:00",
            "duration": "90"
        },
        {
            "title": "Кац",
            "start": "2016-10-18T16:00:00",
            "end": "2016-10-18T21:00:00",
            "duration": "30"
        },
        {
            "title": "Сидоров",
            "start": "2016-10-19T09:30:00",
            "end": "2016-10-19T12:30:00",
            "duration": "40"
        },
        {
            "title": "Kац",
            "start": "2016-10-19T17:30:00",
            "end": "2016-10-19T18:30:00",
            "duration": "30"
        },
        {
            "title": "Иванов",
            "start": "2016-10-19T19:00:00",
            "end": "2016-10-19T20:00:00",
            "duration": "20"
        },
        {
            "title": "Иванов",
            "start": "2016-10-20T09:00:00",
            "end": "2016-10-20T13:00:00",
            "duration": "20"
        },
        {
            "title": "Кац",
            "start": "2016-10-20T13:30:00",
            "end": "2016-10-20T18:30:00",
            "duration": "30"
        },
        {
            "title": "Иванов",
            "start": "2016-10-21T08:30:00",
            "end": "2016-10-21T12:30:00",
            "duration": "20"
        },
        {
            "title": "Кац",
            "start": "2016-10-21T14:30:00",
            "end": "2016-10-21T18:30:00",
            "duration": "30"
        },
        {
            "title": "Иванов",
            "start": "2016-10-22T09:30:00",
            "end": "2016-10-22T12:00:00",
            "duration": "20"
        },
        {
            "title": "Сидоров",
            "start": "2016-10-22T15:30:00",
            "end": "2016-10-22T21:30:00",
            "duration": "40"
        },
        {
            "title": "Иванов",
            "start": "2016-10-23T08:30:00",
            "end": "2016-10-23T10:30:00",
            "duration": "20"
        },
        {
            "title": "Сидоров",
            "start": "2016-10-23T09:30:00",
            "end": "2016-10-23T15:30:00",
            "duration": "40"
        }
        ];
        var examinationList = [
				'Examination1',
                'Examination2'
        ];

        $(document).ready(function () {
            setCalendarEvents([]);

            //$.ajax({
            //    'async': false,
            //    'global': false,
            //    'url': "url",
            //    'dataType': "json",
            //    success: function (data) {
            //        $.each(data, function (i, value) {
            //            $('#locale-selector').append($('<option>').text(value).attr('value', value));
            //        });
            //    }
            //});
            $.each(examinationList, function (i, ex) {
                $('#exam-selector').append(
                    $('<option/>').attr('value', ex).text(ex)
                );
            });

            $('#exam-selector').on('change', function () {
                if (this.value === 'Examination1') {
                    var events = timeOfWeekExamination1;
                }
                else if (this.value === 'Examination2') {
                    var events = timeOfWeekExamination2;
                }
                //var events = $.ajax({
                //    'async': false,
                //    'global': false,
                //    'url': "url",
                //    'dataType': "json",
                //    'success': function (data) {
                //        json = data;
                //    }
                //})
                $('#calendar').fullCalendar('destroy');
                setCalendarEvents(events);
            });

            //$("#timeSelector").on("change", function () {
            //    $("#examTime").text($(this).value);
            //});

            $(function () {
                $("#dialog").dialog({ autoOpen: false, modal: true, resizable: false });
                setOpenFormListener();
                $("a span.ui-icon-closethick").dialog("close");
            });

            $("#submit").click(function (e) {
                var phone = $("#phone").val();
                var lastName = $("#lastName").val();
                var firstName = $("#firstName").val();
                var time = $("#timeSelector").val();
                var phoneReg = /^(\+375|80)(29|25|44|33)(\d{3})(\d{2})(\d{2})$/;
                if (phone === '' || lastName === '' || firstName === '' || time === '') {
                    alert("Заполните все поля.");
                    e.preventDefault();
                } else if (!(phone).match(phoneReg)) {
                    alert("Введите телефон (пример: +375*********) или 80*********");
                    e.preventDefault();
                } else {
                    // ... Request
                    alert("Успешно записано.");
                }
            });
        });

        function setOpenFormListener() {
            $("div a.fc-event").on("click", function () {
                openDialog(this);
            });
        }

        function openDialog(element) {
            $("#dialog").dialog("open");
            $('#timeSelector').focus();
            $("#examName").val($('#exam-selector option:selected').text());
            $("#docName").val($(element).children("div.fc-content").children("div.fc-title").text());
            $("#dateExam").val($($("div.fc-widget-header table thead tr th")[$(element).closest("td").index()]).attr("data-date"));
            var timeSelectorList = getTimeStartExam($(element).children("div.fc-content").children("div.fc-time").text());
            $('#timeSelector option').remove("option[value!='0']");
            $.each(timeSelectorList, function (i, ex) {
                var time = ex._data.hours + ":" + (ex._data.minutes > 9 ? ex._data.minutes : "0" + ex._data.minutes);
                $('#timeSelector').append($('<option/>').attr('value', time).text(time)
                );
            });
        }

        function getTimeStartExam(timePeriod) {
            var duration = moment.duration("00:30:00"); //TODO
            var startTime = moment.duration(timePeriod.split(' - ')[0]);
            var endTime = moment.duration(moment.duration(timePeriod.split(' - ')[1]) - duration);
            var period = moment.duration(endTime - startTime);
            var step = moment.duration("00:15:00");
            var arr = new Array();
            for (x = startTime; x <= endTime; x += step) {
                arr.push(moment.duration(x));
            }
            return arr;
        }

        function setCalendarEvents(ev) {
            $('#calendar').fullCalendar({
                header: {
                    left: 'prev,next',
                    center: 'title',
                    right: ''
                },
                defaultView: 'agendaWeek',
                //defaultView: 'month',
                defaultDate: new Date($.now()),
                locale: 'ru',
                navLinks: false,
                editable: false,
                eventLimit: true,
                weekends: true,
                slotDuration: '00:30:00',
                minTime: '08:00:00',
                maxTime: '22:00:00',
                events: ev
            });

            $("div.fc-button-group button").on("click", function () {
                setOpenFormListener();
            });
            setOpenFormListener();
        }

    </script>
    <style>
        body {
            margin: 10px 10px;
            padding: 0;
            font-family: "Lucida Grande",Helvetica,Arial,Verdana,sans-serif;
            font-size: 14px;
        }

        #calendar {
            max-width: 800px;
            margin: 0 auto;
        }

        div a.fc-event {
            cursor: pointer;
        }

        div[role='dialog'] {
            z-index: 100;
            background: white;
            border: 1px #000 solid;
            padding: 10px;
        }

        div#dialog input {
            width: 100%;
        }

        div.disableElement {
            pointer-events: none;
        }

        div.disableElement input {
            background-color: #ccc;
        }
    </style>
</head>
<body>
    <!--<div id='top'>-->
    <label>Исследование:</label>
    <select id='exam-selector'>
        <option value="0"></option>
    </select>
    <!--</div>-->
    <div id='calendar'></div>
    <div id="dialog" title="Запись на исследование">
        <form action="" method="post">
            <div class="disableElement">
                Исследование:
                <input id="examName" name="examName" type="text" value="">
            </div>
            <div class="disableElement">
                Врач:
                <input id="docName" name="docName" type="text" value="">
            </div>
            <div class="disableElement">
                Записаться на дату:
                <input id="dateExam" name="dateExam" type="text" value="">
            </div>
            <div>
                <label>Время исследования:</label>
                <select id="timeSelector" name="timeSelector">
                    <option value="0"></option>
                </select>
            </div>
            <div>
                Имя:<input id="firstName" name="firstName" type="text">
            </div>
            <div>
                Фамилия:
                <input id="lastName" name="lastName" type="text">
            </div>
            <div>
                Телефон:
                <input id="phone" name="phone" type="text">
            </div>
            <input id="submit" type="submit" value="Submit">
        </form>
    </div>
</body>
</html>